name: CI - Syntax and Pipeline Checks

on:
  push:
    branches: [ "development" ]
  pull_request:
    branches: [ "development" ]

jobs:

  # ==========================
  # Job 1: Syntax Checks
  # ==========================
  syntax_checks:
    name: "Syntax Checks"
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Setup Python
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Install YAML validator
      - name: Install YAML Validator
        run: pip install pyyaml

      # Check Bash files
      - name: Check Bash Syntax
        run: |
          set -e
          for file in $(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA | grep '\.sh$' || true); do
            echo "Checking Bash syntax: $file"
            bash -n "$file"
          done

      # Check Python files
      - name: Check Python Syntax
        run: |
          set -e
          for file in $(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA | grep '\.py$' || true); do
            echo "Checking Python syntax: $file"
            python -m py_compile "$file"
          done

      # Check YAML files
      - name: Validate YAML Syntax
        run: |
          set -e
          for file in $(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA | grep -E '\.ya?ml$' || true); do
            echo "Validating YAML: $file"
            python -c "import yaml; yaml.safe_load(open('$file'))"
          done

  # ==========================
  # Job 2: Pipeline Trigger
  # ==========================
  trigger_pipeline:
    name: "Trigger Pipeline DAGs"
    runs-on: ubuntu-latest
    needs: syntax_checks     
    if: github.ref == 'refs/heads/development'  

    steps:
      # Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Verify Docker Compose is already installed (pre-installed on GitHub Actions runners)
      - name: Verify Docker Compose
        run: |
          echo "Checking Docker Compose version..."
          docker compose version
          docker version

      # Start Docker Compose services
      - name: Start Docker Compose
        run: |
          echo "Starting Docker Compose for Airflow + Spark + Kafka..."
          docker compose -f docker-compose.dev.yml up -d

      # Wait for Airflow to be ready with proper health check
      - name: Wait for Airflow Services
        run: |
          echo "Waiting for Airflow webserver to be ready..."
          # Try for up to 5 minutes
          timeout 300 bash -c '
            until docker compose exec airflow-webserver airflow version &> /dev/null; do
              echo "Airflow not ready yet, waiting 5 seconds..."
              sleep 5
            done
          ' || {
            echo "Airflow failed to start within 5 minutes"
            echo "Showing recent logs:"
            docker compose logs --tail=50
            exit 1
          }
          echo "Airflow is ready!"

      # Trigger Pipeline DAGs
      - name: Trigger DAGs
        run: |
          echo "Triggering DAGs..."
          chmod +x scripts/trigger_pipeline_dag.sh
          ./scripts/trigger_pipeline_dag.sh

      # Optional: Check DAG status (if your script doesn't already do this)
      - name: Verify DAG Execution
        run: |
          echo "Checking DAG execution status..."
          # Add your DAG status check logic here
          # For example:
          # for dag in dag1 dag2 dag3; do
          #   curl -f "http://localhost:8080/api/v1/dags/${dag}/dagRuns?state=success" || exit 1
          # done
          echo "All DAGs triggered successfully!"

    
      - name: Cleanup Docker
        if: always()
        run: |
          echo "Cleaning up Docker containers..."
          docker compose -f docker-compose.dev.yml down
