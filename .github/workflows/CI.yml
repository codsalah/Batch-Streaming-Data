name: CI - Fast Checks on Modified Files

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci_checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # fetch full history for git diff

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Check modified files
        run: |
          set -e  # stop job on first error

          # Get all files from the current push or PR commit
          MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA)

          if [ -z "$MODIFIED_FILES" ]; then
            echo "No modified files to check."
          else
            echo "Modified files:"
            echo "$MODIFIED_FILES" | cat -A  # shows hidden chars and spaces

            # Use safe loop to handle filenames with spaces or special chars
            echo "$MODIFIED_FILES" | while IFS= read -r file; do
              echo "Processing '$file'..."

              # Bash scripts: syntax check
              if [[ $file == *.sh ]]; then
                echo "Checking Bash syntax for $file"
                bash -n "$file" || exit 1
              fi

              # Python files: compile check
              if [[ $file == *.py ]]; then
                echo "Checking Python syntax for $file"
                python -m py_compile "$file" || exit 1
              fi

              # YAML files (docker-compose, workflow, etc.): config validation
              if [[ $file == *.yml || $file == *.yaml ]]; then
                echo "Validating YAML file $file"
                docker-compose -f "$file" config || exit 1
              fi

            done
          fi
